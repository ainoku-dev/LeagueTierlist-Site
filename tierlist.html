<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Tierlist – List</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Load the skin data. This script defines `window.SKINS_DATA` containing the array of skins. -->
    <script src="skins_data.js"></script>
    <script>
        const USERS = ['User1','User2','User3','User4'];
        const RATING_LABELS = ['Dogshit','Cringe','Basic','Awesome','Supreme','Perfect'];
        let viewMode = 'avg';
        function getCurrentUser() {
            return localStorage.getItem('currentUser');
        }
        function getUserRatings() {
            const key = 'ratings_' + getCurrentUser();
            try {
                return JSON.parse(localStorage.getItem(key)) || {};
            } catch (err) {
                return {};
            }
        }
        function setUserRatings(ratings) {
            const key = 'ratings_' + getCurrentUser();
            localStorage.setItem(key, JSON.stringify(ratings));
        }
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        function resetAll() {
            if (!confirm('Reset all ratings?')) return;
            setUserRatings({});
            populateGrid();
        }
        function resetChampion(champ) {
            if (!champ) return;
            if (!confirm(`Reset ratings for ${champ}?`)) return;
            const ratings = getUserRatings();
            (window.SKINS_DATA || []).forEach(s => {
                if (s.champion === champ) delete ratings[s.image];
            });
            setUserRatings(ratings);
            populateGrid();
        }
        function resetSkin(imageKey) {
            const ratings = getUserRatings();
            if (ratings[imageKey] !== undefined) {
                delete ratings[imageKey];
                setUserRatings(ratings);
                populateGrid();
            }
        }
        // Convert a numeric rating (0–5) to its textual label.
        function ratingToLabel(num) {
            return RATING_LABELS[num] ?? 'Unrated';
        }
        function getRatingForSkin(skin) {
            if (viewMode === "avg") {
                return skin.avgRating;
            }
            const ratings = getUserRatings();
            const r = ratings[skin.image];
            return typeof r === "number" ? r : -1;
        }
        // Compute the average rating for a skin across all users.
        function computeAverage(imageKey) {
            let sum = 0;
            let count = 0;
            for (const user of USERS) {
                const storeKey = "ratings_" + user;
                let ratings = {};
                try {
                    ratings = JSON.parse(localStorage.getItem(storeKey)) || {};
                } catch (err) {
                    ratings = {};
                }
                const r = ratings[imageKey];
                if (r !== undefined && r !== null && !isNaN(Number(r))) {
                    sum += Number(r);
                    count += 1;
                }
            }
            return count ? sum / count : -1;
        }
        // Generate the HTML grid based on data and insert into the DOM.
        async function populateGrid() {
            const container = document.getElementById("skin-grid");
            container.innerHTML = "";
            const skins = window.SKINS_DATA || [];
            const champSelect = document.getElementById("champ-select");
            if (champSelect && champSelect.options.length <= 1) {
                const champs = [...new Set(skins.map(s => s.champion))].sort();
                champs.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    champSelect.appendChild(opt);
                });
            }
            const userRatings = getUserRatings();
            skins.forEach(skin => {
                skin.avgRating = computeAverage(skin.image);
                skin.userRating = userRatings[skin.image];
            });
            const groups = {5:[],4:[],3:[],2:[],1:[],0:[],unrated:[]};
            skins.forEach(skin => {
                const r = getRatingForSkin(skin);
                const key = r >= 0 ? Math.round(r) : "unrated";
                groups[key].push(skin);
            });
            const order = [5,4,3,2,1,0,"unrated"];
            for (const key of order) {
                const arr = groups[key];
                if (!arr.length) continue;
                const groupDiv = document.createElement("div");
                groupDiv.className = "rating-group";
                const h = document.createElement("h3");
                h.textContent = key === "unrated" ? "Unrated" : ratingToLabel(key);
                groupDiv.appendChild(h);
                const grid = document.createElement("div");
                grid.className = "grid-container";
                arr.forEach(skin => {
                    const card = document.createElement("div");
                    card.className = "skin-card";
                    const reset = document.createElement("button");
                    reset.textContent = "Reset";
                    reset.className = "secondary-button reset-btn";
                    reset.addEventListener("click", (e) => {
                        e.stopPropagation();
                        resetSkin(skin.image);
                    });
                    card.appendChild(reset);
                    const img = document.createElement("img");
                    img.src = skin.image;
                    img.alt = `${skin.champion} – ${skin.skin}`;
                    img.loading = "lazy";
                    card.appendChild(img);
                    const info = document.createElement("div");
                    info.className = "skin-info";
                    const nameDiv = document.createElement("div");
                    nameDiv.textContent = `${skin.champion} – ${skin.skin}`;
                    const ratingDiv = document.createElement("div");
                    const val = getRatingForSkin(skin);
                    if (val === -1) {
                        ratingDiv.textContent = viewMode === "avg" ? "Average: Unrated" : "Your Rating: Unrated";
                    } else {
                        const rounded = Math.round(val);
                        const label = ratingToLabel(rounded);
                        if (viewMode === "avg") {
                            ratingDiv.textContent = `Average: ${label} (${val.toFixed(2)})`;
                        } else {
                            ratingDiv.textContent = `Your Rating: ${label}`;
                        }
                    }
                    info.appendChild(nameDiv);
                    info.appendChild(ratingDiv);
                    card.appendChild(info);
                    grid.appendChild(card);
                });
                groupDiv.appendChild(grid);
                container.appendChild(groupDiv);
            }
        }
        window.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById('start-rating');
            startButton.addEventListener('click', () => {
                window.location.href = 'rate.html';
            });
            const resetAllBtn = document.getElementById('reset-all');
            if (resetAllBtn) {
                resetAllBtn.addEventListener('click', resetAll);
            }
            const resetChampBtn = document.getElementById('reset-champ');
            const toggleBtn = document.getElementById("toggle-view");
            if (toggleBtn) {
                toggleBtn.textContent = viewMode === "avg" ? "Show My Ratings" : "Show Averages";
                toggleBtn.addEventListener("click", () => {
                    viewMode = viewMode === "avg" ? "user" : "avg";
                    toggleBtn.textContent = viewMode === "avg" ? "Show My Ratings" : "Show Averages";
                    populateGrid();
                });
            }
            if (resetChampBtn) {
                resetChampBtn.addEventListener('click', () => {
                    const sel = document.getElementById('champ-select');
                    resetChampion(sel ? sel.value : '');
                });
            }
            populateGrid();
        });
    </script>
</head>
<body class="tierlist-page">
    <header class="tierlist-header">
        <button id="start-rating" class="primary-button">START RATING</button>
        <select id="champ-select">
            <option value="">Select Champion</option>
        </select>
        <button id="reset-champ" class="secondary-button">Reset Champ</button>
        <button id="reset-all" class="secondary-button">Reset All</button>
        <button id="toggle-view" class="secondary-button">Show My Ratings</button>
        <button onclick="logout()" class="secondary-button">LOGOUT</button>
    </header>
    <main class="tierlist-main">
        <div id="skin-grid" class="grid-container"></div>
    </main>
</body>
</html>
